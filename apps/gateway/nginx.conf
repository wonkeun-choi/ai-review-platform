# 1. 기본 설정
events {}
http {
    # 2. 백엔드 서비스들의 내부 주소를 정의 (docker-compose.yml의 서비스 이름 사용)
    upstream frontend {
        server web:80; # web 서비스의 Nginx (Dockerfile 기반)
    }
    upstream coding_service {
        server coding-service:8000;
    }
    upstream interview_service {
        server interview-service:8001;
    }
    upstream review_service {
        server review-service:8002;
    }
    upstream judge0_api {
        server judge0-api:2358;
    }

    server {
        listen 80; # 80번 포트로 들어오는 모든 요청을 받음
        server_name localhost;

        # 3. API 라우팅 (Vite 프록시 설정을 Nginx가 대신함)
        location /api/coding/ {
            proxy_pass http://coding_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_read_timeout 180s;
            proxy_connect_timeout 180s;
        }
        location /api/interview/ {
            proxy_pass http://interview_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_read_timeout 180s;
            proxy_connect_timeout 180s;            
        }
        location /api/review/ {
            proxy_pass http://review_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_read_timeout 180s;
            proxy_connect_timeout 180s;
        }
        
        # (선택) Judge0 API도 게이트웨이를 통해 노출할 경우
        location /submissions {
            proxy_pass http://judge0_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 4. 그 외 모든 요청은 프런트엔드(web)로 전달
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}