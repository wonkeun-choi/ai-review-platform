services:
  # ------------------------------------------------
  # üåê GATEWAY (Nginx reverse proxy)
  # ------------------------------------------------
  gateway:
    image: nginx:1.27-alpine
    container_name: gateway
    ports:
      - "80:80"
    volumes:
      - ./apps/gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - web
      - review-service
      - coding-service
      - interview-service
    networks: [appnet]

  # ------------------------------------------------
  # üíª FRONTEND (React / Next / Vite)
  # ------------------------------------------------
  web:
    build:
      context: ./apps/web/web-react
      dockerfile: Dockerfile
    container_name: web
    networks: [appnet]

  # ------------------------------------------------
  # üîç REVIEW SERVICE (FastAPI)
  # ------------------------------------------------
  review-service:
    build: ./apps/review-service
    container_name: review-service
    env_file:
      - .env
    expose:
      - "8001"
    networks: [appnet]

  # ------------------------------------------------
  # ü§ñ INTERVIEW SERVICE (FastAPI)
  # ------------------------------------------------
  interview-service:
    build: ./apps/interview-service
    container_name: interview-service
    env_file:
      - .env
    expose:
      - "8002"
    networks: [appnet]

  # ------------------------------------------------
  # üí° CODING SERVICE (FastAPI + Judge0)
  # ------------------------------------------------
  coding-service:
    build: ./apps/coding-service
    container_name: coding-service
    env_file:
      - .env
    environment:
      - JUDGE0_URL=http://judge0-api:2358
    expose:
      - "8000"
    depends_on:
      - judge0-api
    networks: [appnet]

  # ------------------------------------------------
  # üóÑÔ∏è POSTGRES (for Judge0)
  # ------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: judge0-db
    environment:
      POSTGRES_DB: judge0
      POSTGRES_USER: judge0
      POSTGRES_PASSWORD: judge0
    volumes:
      - judge0-db:/var/lib/postgresql/data
    networks: [appnet]

  # ------------------------------------------------
  # ‚öôÔ∏è JUDGE0 API
  # ------------------------------------------------
  judge0-api:
    image: judge0/judge0:latest
    container_name: judge0-api
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=judge0
      - ENABLE_ACCESS_LOG=1
      - MAX_EXECUTION_TIME=10
    depends_on:
      - postgres
    networks: [appnet]
    ports:
      - "2358:2358"

  # ------------------------------------------------
  # üßµ JUDGE0 WORKER
  # ------------------------------------------------
  judge0-worker:
    image: judge0/judge0:latest
    container_name: judge0-worker
    command: ["./scripts/workers/run.sh"]
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=judge0
    depends_on:
      - postgres
      - judge0-api
    networks: [appnet]

# ------------------------------------------------
# üîó NETWORKS & VOLUMES
# ------------------------------------------------
networks:
  appnet:

volumes:
  judge0-db:
